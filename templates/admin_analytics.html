{% extends "base.html" %}

{% block title %}Analytics - AttendEase{% endblock %}

{% block header %}Analytics Dashboard{% endblock %}

{% block content %}
<div class="row g-4 mb-4">
    <!-- Attendance Overview -->
    <div class="col-md-6">
        <div class="content-card h-100">
            <h5 class="mb-4 text-primary">Monthly Attendance Overview</h5>
            <div class="chart-container" style="position: relative; height:300px; width:100%">
                <canvas id="attendanceChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Section-wise Attendance -->
    <div class="col-md-6">
        <div class="content-card h-100">
            <h5 class="mb-4 text-success">Section-wise Attendance</h5>
            <div class="chart-container" style="position: relative; height:300px; width:100%">
                <canvas id="sectionAttendanceChart"></canvas>
            </div>
            <p class="text-muted small text-center mt-3">Click on a bar to view subject-wise breakdown.</p>
        </div>
    </div>
</div>

<!-- Subject-wise Attendance for Selected Section -->
<div class="row" id="subjectAttendanceCard" style="display: none;">
    <div class="col-12">
        <div class="content-card">
            <h5 class="mb-4 text-info">Subject breakdown for: <span id="selectedSectionName" class="fw-bold"></span>
            </h5>
            <div id="subjectDonutChartsContainer" class="row g-4"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Fetch data from the backend
    async function fetchData() {
        const response = await fetch('/api/analytics');
        const data = await response.json();
        return data;
    }

    // Render Charts
    async function renderCharts() {
        const data = await fetchData();

        // Attendance Overview Chart
        const attendanceCtx = document.getElementById('attendanceChart').getContext('2d');
        new Chart(attendanceCtx, {
            type: 'line',
            data: {
                labels: data.attendance_overview.labels,
                datasets: [{
                    label: 'Attendance %',
                    data: data.attendance_overview.data,
                    borderColor: '#2575fc',
                    backgroundColor: 'rgba(37, 117, 252, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: { borderDash: [5, 5] }
                    },
                    x: { grid: { display: false } }
                }
            }
        });

        // Section-wise Attendance Chart
        const sectionCtx = document.getElementById('sectionAttendanceChart').getContext('2d');
        const sectionChart = new Chart(sectionCtx, {
            type: 'bar',
            data: {
                labels: data.section_attendance.labels,
                datasets: [{
                    label: 'Attendance %',
                    data: data.section_attendance.data,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                    ],
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                },
                onClick: async (event, elements) => {
                    if (elements.length > 0) {
                        const sectionIndex = elements[0].index;
                        const sectionName = data.section_attendance.labels[sectionIndex];

                        // Fetch subject-wise attendance for the selected section
                        const subjectResponse = await fetch(`/api/subject-attendance?section=${sectionName}`);
                        const subjectData = await subjectResponse.json();

                        // Update the selected section name
                        document.getElementById('selectedSectionName').textContent = sectionName;

                        // Show the subject-wise attendance card
                        const card = document.getElementById('subjectAttendanceCard');
                        card.style.display = 'block';
                        card.scrollIntoView({ behavior: 'smooth' });

                        // Clear previous donut charts
                        const container = document.getElementById('subjectDonutChartsContainer');
                        container.innerHTML = '';

                        // Render a donut chart for each subject
                        subjectData.forEach(subject => {
                            const chartDiv = document.createElement('div');
                            chartDiv.className = 'col-md-4 text-center';

                            const canvasContainer = document.createElement('div');
                            canvasContainer.style.height = "200px";
                            canvasContainer.style.position = "relative";

                            const canvas = document.createElement('canvas');
                            canvasContainer.appendChild(canvas);

                            const title = document.createElement('h6');
                            title.className = "mt-2";
                            title.textContent = subject.subject_name;

                            chartDiv.appendChild(canvasContainer);
                            chartDiv.appendChild(title);
                            container.appendChild(chartDiv);

                            const subjectDonutCtx = canvas.getContext('2d');
                            new Chart(subjectDonutCtx, {
                                type: 'doughnut',
                                data: {
                                    labels: ['Present', 'Absent'],
                                    datasets: [{
                                        data: [subject.attendance_percentage, 100 - subject.attendance_percentage],
                                        backgroundColor: ['#28a745', '#dc3545'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false
                                }
                            });
                        });
                    }
                }
            }
        });
    }

    renderCharts();
</script>
{% endblock %}