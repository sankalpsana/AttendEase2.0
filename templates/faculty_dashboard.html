{% extends "base.html" %}

{% block title %}Faculty Dashboard - AttendEase{% endblock %}

{% block header %}Faculty Dashboard{% endblock %}

{% block content %}
<!-- My Classes -->
<div class="mb-5">
    <h4 class="mb-3 text-white"><i class="fas fa-chalkboard me-2"></i>My Classes</h4>
    <div class="row g-4" id="classesContainer">
        <!-- Classes will be dynamically populated here -->
        <div class="col-12 text-center text-white">Loading classes...</div>
    </div>
</div>

<!-- Substitute Section -->
<div class="row g-4 mb-5">
    <div class="col-md-12">
        <div class="content-card">
            <h4 class="mb-3 border-bottom pb-2">Assign Substitute Faculty</h4>
            <div id="assignSubstituteContainer">
                <div class="text-center text-muted">Loading substitute form...</div>
            </div>
        </div>
    </div>
</div>

<!-- Substitute Assignments -->
<div class="row g-4">
    <div class="col-md-6">
        <div class="content-card h-100">
            <h5 class="mb-3 text-primary"><i class="fas fa-calendar-alt me-2"></i>My Requests (Assignments)</h5>
            <div id="substituteAssignmentsContainer">
                <div class="text-center text-muted">Loading...</div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="content-card h-100">
            <h5 class="mb-3 text-success"><i class="fas fa-chalkboard-teacher me-2"></i>Classes Assigned to Me</h5>
            <div id="substituteClassesContainer">
                <div class="text-center text-muted">Loading...</div>
            </div>
        </div>
    </div>
</div>

<style>
    .sub-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        border-left: 4px solid #2575fc;
    }

    .no-data {
        font-style: italic;
        color: #999;
        text-align: center;
        padding: 10px;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const facultyId = "{{ session.get('id') }}";

        // Fetch the faculty's assigned classes
        fetch('/fetch-faculty-classes')
            .then(response => response.json())
            .then(data => {
                const classesContainer = document.getElementById('classesContainer');
                classesContainer.innerHTML = ''; // Clear existing content

                if (data.success && data.classes.length > 0) {
                    data.classes.forEach(cls => {
                        const card = `
                            <div class="col-md-4">
                                <div class="content-card h-100 hover-scale">
                                    <h5 class="text-primary">${cls.subject_name}</h5>
                                    <p class="text-muted mb-4">${cls.section_name}</p>
                                    <div class="d-grid gap-2">
                                        <a href="/faculty-attendance?subject_id=${cls.subject_id}&section_name=${cls.section_name}" class="btn btn-outline-primary btn-sm">View Attendance</a>
                                        <a href="/mark-attendance?faculty_id=${facultyId}&subject_id=${cls.subject_id}&section_name=${cls.section_name}" class="btn btn-gradient btn-sm">Mark Attendance</a>
                                    </div>
                                </div>
                            </div>
                        `;
                        classesContainer.insertAdjacentHTML('beforeend', card);
                    });
                } else if (data.success) {
                    classesContainer.innerHTML = '<div class="col-12 text-center text-white">No classes assigned.</div>';
                } else {
                    classesContainer.innerHTML = `<div class="col-12 text-center text-danger">Error: ${data.message}</div>`;
                }
            });

        // Fetch faculty for substitute assignment
        fetch('/fetch-faculty')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const facultySelect = document.createElement('select');
                    facultySelect.id = 'substituteFacultySelect';
                    facultySelect.className = 'form-select';
                    facultySelect.innerHTML = '<option value="">Select Substitute Faculty</option>';
                    data.faculty.forEach(faculty => {
                        if (faculty.faculty_id !== facultyId) { // Exclude the logged-in faculty
                            facultySelect.innerHTML += `<option value="${faculty.faculty_id}">${faculty.name}</option>`;
                        }
                    });

                    // Populate the substitute assignment form
                    const assignSubstituteContainer = document.getElementById('assignSubstituteContainer');
                    assignSubstituteContainer.innerHTML = `
                        <form id="assignSubstituteForm" class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Select Class</label>
                                <select class="form-select" id="classSelect" required>
                                    <option value="" disabled selected>Loading classes...</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Select Substitute</label>
                                ${facultySelect.outerHTML}
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" id="dateInput" required>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">Assign</button>
                            </div>
                        </form>
                    `;

                    // Populate the class dropdown
                    fetch('/fetch-faculty-classes')
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const classSelect = document.getElementById('classSelect');
                                classSelect.innerHTML = '<option value="" disabled selected>Select Class</option>';
                                data.classes.forEach(cls => {
                                    classSelect.innerHTML += `<option value="${cls.subject_id}-${cls.section_name}">${cls.subject_name} - ${cls.section_name}</option>`;
                                });
                            }
                        });

                    // Handle form submission
                    document.getElementById('assignSubstituteForm').addEventListener('submit', function (e) {
                        e.preventDefault();

                        const classValue = document.getElementById('classSelect').value;
                        if (!classValue) { alert("Please select a class"); return; }

                        const [subjectId, sectionName] = classValue.split('-');
                        const substituteFacultyId = document.getElementById('substituteFacultySelect').value;
                        const date = document.getElementById('dateInput').value;

                        fetch('/assign-substitute', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                substitute_faculty_id: substituteFacultyId,
                                subject_id: subjectId,
                                section_name: sectionName,
                                date: date,
                            }),
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert('Substitute assigned successfully!');
                                    location.reload();
                                } else {
                                    alert('Error: ' + data.message);
                                }
                            });
                    });
                }
            });

        // Fetch substitute assignments (My Requests)
        fetch('/fetch-substitute-assignments')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('substituteAssignmentsContainer');
                container.innerHTML = '';

                if (data.success && data.substitute_assignments.length > 0) {
                    data.substitute_assignments.forEach(assignment => {
                        const item = `
                            <div class="sub-card">
                                <strong>${assignment.subject_name} (${assignment.section_name})</strong>
                                <div class="small">Assigned to: ${assignment.substitute_faculty_name}</div>
                                <div class="small text-muted">Date: ${assignment.date}</div>
                            </div>
                        `;
                        container.insertAdjacentHTML('beforeend', item);
                    });
                } else {
                    container.innerHTML = `<div class="no-data">No active requests.</div>`;
                }
            });

        // Fetch substitute classes (Assigned to Me)
        fetch('/fetch-substitute-classes-for-substitute')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('substituteClassesContainer');
                container.innerHTML = '';

                if (data.success && data.substitute_classes.length > 0) {
                    data.substitute_classes.forEach(cls => {
                        const item = `
                            <div class="sub-card border-start border-success border-4">
                                <strong>${cls.subject_name} (${cls.section_name})</strong>
                                <div class="small">From: ${cls.original_faculty_name}</div>
                                <div class="small text-muted mb-2">Date: ${cls.date}</div>
                                <a href="/mark-attendance?faculty_id=${facultyId}&subject_id=${cls.subject_id}&section_name=${cls.section_name}" class="btn btn-sm btn-success w-100">Mark Attendance</a>
                            </div>
                        `;
                        container.insertAdjacentHTML('beforeend', item);
                    });
                } else {
                    container.innerHTML = `<div class="no-data">No substitute classes assigned to you.</div>`;
                }
            });
    });
</script>
<style>
    .hover-scale {
        transition: transform 0.2s;
    }

    .hover-scale:hover {
        transform: translateY(-5px);
    }
</style>
{% endblock %}